---
import RootLayout from "@/layouts/RootLayout.astro";
import ListLayoutWithImages from "@/layouts/ListLayoutWithImages.astro";
import { getCollection } from "astro:content";
import {
  getPostSlug,
  isPostPublished,
  sortPostsByDate,
  resolvePostImages,
} from "@/lib/utils-blog";
import SEO from "@/components/seo/index.astro";
import Schema from "@/components/structured-data/index.astro";

// Get all non-draft blog posts
const posts = await getCollection("blog", isPostPublished);
const sortedPosts = sortPostsByDate(posts);

// Transform posts to match the expected interface
const transformedPosts: {
  slug: string;
  date: string;
  title: string;
  summary: string;
  tags: string[];
  images: string[];
  draft?: boolean;
}[] = sortedPosts.map((post) => ({
  slug: getPostSlug(post),
  date: post.data.date,
  title: post.data.title,
  summary: post.data.summary,
  tags: post.data.tags || [],
  images: resolvePostImages(post),
  draft: post.data.draft || false,
}));

// Pagination: first page
const PAGE_SIZE = 6;
const totalPages = Math.ceil(transformedPosts.length / PAGE_SIZE) || 1;
const pageOnePosts = transformedPosts.slice(0, PAGE_SIZE);
---

<RootLayout>
  <SEO slot="seo" title="Blog" />
  <Schema slot="ld+json" type="WebSite" />
  <ListLayoutWithImages
    posts={pageOnePosts}
    pagination={{ totalPages: totalPages, currentPage: 1 }}
  />
</RootLayout>

---
import RootLayout from "@/layouts/RootLayout.astro";
import ListLayoutWithTags from "@/layouts/ListLayoutWithTags.astro";
import { getCollection } from "astro:content";
import {
  getPostSlug,
  isPostPublished,
  filterPostsByTag,
  getAllTags,
} from "@/lib/utils";

export async function getStaticPaths() {
  const posts = await getCollection("blog", isPostPublished);
  const tags = getAllTags(posts);

  return tags.map((tag) => ({
    params: { tag },
    props: { tag, posts },
  }));
}

const { tag, posts } = Astro.props;

// Filter posts by tag
const filteredPosts = filterPostsByTag(posts, tag);

// Transform posts to match the expected interface
const transformedPosts = filteredPosts.map((post) => ({
  path: `blog/${getPostSlug(post)}`,
  date: post.data.date,
  title: post.data.title,
  summary: post.data.summary,
  tags: post.data.tags || [],
}));
---

<RootLayout title={`Posts tagged with "${tag}" - Blog`}>
  <ListLayoutWithTags
    posts={transformedPosts}
    title={`Posts tagged with "${tag}"`}
  >
    <p>Here are all the blog posts tagged with <strong>{tag}</strong>.</p>
  </ListLayoutWithTags>
</RootLayout>
